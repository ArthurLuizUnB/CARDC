{% extends "base.html" %}

{% block title %}Novo Ciclo de Estudo{% endblock %}

{% block content %}
    <h2>{{ '✏️ Editando: ' + ciclo.obra if ciclo else '➕ Novo Ciclo de Estudo' }}</h2>

    <form action="{{ url_for('routes.novo_ciclo') if not ciclo else url_for('routes.editar_ciclo', ciclo_id=ciclo.id) }}" method="POST" class="formulario" enctype="multipart/form-data">

        <h3>1º Passo</h3>
        <label for="obra">Obra:</label>
        <input type="text" id="obra" name="obra" required value="{{ ciclo.obra if ciclo else '' }}">

        <label for="compositor">Compositor:</label>
        <input type="text" id="compositor" name="compositor" required value="{{ ciclo.compositor if ciclo else '' }}">

        <label for="data_inicio">Início:</label>
        <input type="date" id="data_inicio" name="data_inicio" required value="{{ ciclo.data_inicio if ciclo else now.strftime('%Y-%m-%d') }}">

<label for="data_finalizacao">Finalização:</label>
        <input type="date" id="data_finalizacao" name="data_finalizacao" value="{{ ciclo.data_finalizacao if ciclo else '' }}">

        <label for="video_upload">Adicionar Gravação (Galeria):</label>
        <input type="file" id="video_upload" name="video_upload" accept="video/*">
        
        <div class="recorder-container">
            <label>Ou Gravar agora (Webcam):</label>
            <video id="videoPreview" width="100%" autoplay muted style="display: none;"></video>
            
            <div class="recorder-actions">
                <button type="button" id="startRecordBtn" class="btn btn-action btn-record">Gravar</button>
                <button type="button" id="stopRecordBtn" class="btn btn-action btn-stop" disabled>Parar</button>
            </div>
        </div>

        <div class="gallery-container">
            <h3>Gravações Salvas</h3>
            {% if gravacoes %}
                <ul class="recording-list">
                {% for gravacao in gravacoes %}
                    <li class="recording-item">
                        <video width="100%" controls>
                            <source src="{{ gravacao.url_video }}" type="video/webm">
                            <source src="{{ gravacao.url_video }}" type="video/mp4">
                            Seu navegador não suporta vídeos.
                        </video>
                        <p class="recording-date">
                            Enviado em: {{ gravacao.data_envio.strftime('%d/%m/%Y às %H:%M') }}
                        </p>

                        <a href="{{ url_for('routes.remover_gravacao', gravacao_id=gravacao.id) }}" 
                           class="btn-sm btn-danger btn-delete-video"
                           onclick="return confirm('Tem a certeza que quer apagar este vídeo? Esta ação não pode ser desfeita.')">
                           Excluir Vídeo
                        </a>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="no-items">Nenhuma gravação enviada para este ciclo ainda.</p>
            {% endif %}
        </div>

        <label for="consideracoes_preliminares">Considerações preliminares:</label>
        <textarea id="consideracoes_preliminares" name="consideracoes_preliminares" rows="3">{{ ciclo.consideracoes_preliminares or '' }}</textarea>
        <h3 class="mt-4">2º Passo</h3>
        <label for="acao_artistica">Ação artística:</label>
        <textarea id="acao_artistica" name="acao_artistica" rows="3">{{ ciclo.acao_artistica or '' }}</textarea>

        <label for="descricao_tarefa">Descrição da tarefa:</label>
        <textarea id="descricao_tarefa" name="descricao_tarefa" rows="3">{{ ciclo.descricao_tarefa or '' }}</textarea>

        <label for="resultado_tecnico">Resultado técnico:</label>
        <textarea id="resultado_tecnico" name="resultado_tecnico" rows="3">{{ ciclo.resultado_tecnico or '' }}</textarea>

        <label for="resultado_musical">Resultado musical:</label>
        <textarea id="resultado_musical" name="resultado_musical" rows="3">{{ ciclo.resultado_musical or '' }}</textarea>

        <h3 class="mt-4">3º Passo</h3>
        <label for="observacoes">Observações:</label>
        <textarea id="observacoes" name="observacoes" rows="3">{{ ciclo.observacoes or '' }}</textarea>

        <label for="pensamentos_associados">Pensamentos associados:</label>
        <textarea id="pensamentos_associados" name="pensamentos_associados" rows="3">{{ ciclo.pensamentos_associados or '' }}</textarea>

        <label for="emocoes_associadas">Emoções associadas:</label>
        <textarea id="emocoes_associadas" name="emocoes_associadas" rows="3">{{ ciclo.emocoes_associadas or '' }}</textarea>

        <label for="diario_reflexivo">Diário reflexivo:</label>
        <textarea id="diario_reflexivo" name="diario_reflexivo" rows="5">{{ ciclo.diario_reflexivo or '' }}</textarea>

        <div class="form-group checkbox-group">
            <label for="terminado">Finalizar ciclo</label>
            <input class="form-check-input" type="checkbox" name="terminado" id="terminado" {% if ciclo and ciclo.status == "finalizado" %}checked{% endif %}>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('routes.home') }}" class="btn btn-action cancel">Cancelar</a>
            <button type="submit" class="btn btn-action">Salvar</button>
        </div>
    </form>

    <script src="{{ url_for('static', filename='js/recorder.js') }}"></script>

{% endblock %}